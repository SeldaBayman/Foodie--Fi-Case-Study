D. Outside The Box Questions
The following are open ended questions which might be asked during a technical interview for this case study - there are no right or wrong answers, but answers that make sense from both a technical and a business perspective make an amazing impression!

1-How would you calculate the rate of growth for Foodie-Fi?
WITH customer_counts AS (
    SELECT 
        EXTRACT(YEAR FROM start_date) AS year,
        EXTRACT(MONTH FROM start_date) AS month,
        COUNT(DISTINCT customer_id) AS customer_count
    FROM subscriptions
    GROUP BY year, month
)
SELECT 
    year, 
    month, 
    customer_count,
    LAG(customer_count) OVER (ORDER BY year, month) AS prev_month_customers,
    ROUND(((customer_count - LAG(customer_count) OVER (ORDER BY year, month)) / LAG(customer_count) OVER (ORDER BY year, month)) * 100, 2) AS growth_rate_percentage
FROM customer_counts;

2-What key metrics would you recommend Foodie-Fi management to track over time to assess performance of their overall business?
WITH monthly_mrr AS (
    SELECT 
        EXTRACT(YEAR FROM start_date) AS year,
        EXTRACT(MONTH FROM start_date) AS month,
        CASE 
            WHEN plan_name = 'Basic Monthly' THEN 10
            WHEN plan_name = 'Pro Monthly' THEN 20
            WHEN plan_name = 'Annual' THEN 200 / 12  -- Annual plan distributed monthly
            ELSE 0
        END AS monthly_revenue
    FROM subscriptions
)
SELECT 
    year, 
    month,
    ROUND(SUM(monthly_revenue), 2) AS total_mrr
FROM monthly_mrr
GROUP BY year, month
ORDER BY year, month;

WITH active_customers AS (
    SELECT 
        EXTRACT(MONTH FROM start_date) AS month,
        COUNT(DISTINCT customer_id) AS active_customers
    FROM subscriptions
    WHERE plan_name != 'Cancelled'
    GROUP BY month
),
cancelled_customers AS (
    SELECT 
        EXTRACT(MONTH FROM start_date) AS month,
        COUNT(DISTINCT customer_id) AS cancelled_customers
    FROM subscriptions
    WHERE plan_name = 'Cancelled'
    GROUP BY month
)
SELECT 
    a.month,
    a.active_customers,
    c.cancelled_customers,
    ROUND((c.cancelled_customers * 100.0) / a.active_customers, 2) AS churn_rate
FROM active_customers a
LEFT JOIN cancelled_customers c
ON a.month = c.month;

WITH active_customers AS (
    SELECT 
        EXTRACT(MONTH FROM start_date) AS month,
        COUNT(DISTINCT customer_id) AS active_customers
    FROM subscriptions
    WHERE plan_name != 'Cancelled'
    GROUP BY month
),
cancelled_customers AS (
    SELECT 
        EXTRACT(MONTH FROM start_date) AS month,
        COUNT(DISTINCT customer_id) AS cancelled_customers
    FROM subscriptions
    WHERE plan_name = 'Cancelled'
    GROUP BY month
)
SELECT 
    a.month,
    a.active_customers,
    c.cancelled_customers,
    ROUND((c.cancelled_customers * 100.0) / a.active_customers, 2) AS churn_rate
FROM active_customers a
LEFT JOIN cancelled_customers c
ON a.month = c.month;
WITH customer_lifetime AS (
    SELECT 
        customer_id,
        plan_name,
        MIN(start_date) AS first_date,
        MAX(start_date) AS last_date,
        CASE 
            WHEN plan_name = 'Basic Monthly' THEN 10 * (TIMESTAMPDIFF(MONTH, MIN(start_date), MAX(start_date)) + 1)
            WHEN plan_name = 'Pro Monthly' THEN 20 * (TIMESTAMPDIFF(MONTH, MIN(start_date), MAX(start_date)) + 1)
            WHEN plan_name = 'Annual' THEN 200
            ELSE 0
        END AS total_value
    FROM subscriptions
    GROUP BY customer_id, plan_name
)
SELECT 
    plan_name,
    ROUND(AVG(total_value), 2) AS avg_lifetime_value
FROM customer_lifetime
GROUP BY plan_name;

3-What are some key customer journeys or experiences that you would analyse further to improve customer retention?
WITH cancellations AS (
    SELECT 
        customer_id,
        EXTRACT(MONTH FROM start_date) AS month,
        COUNT(*) AS cancelled
    FROM subscriptions
    WHERE plan_name = 'Cancelled'
    GROUP BY customer_id, month
)
SELECT 
    month,
    COUNT(customer_id) AS cancelled_customers
FROM cancellations
GROUP BY month
ORDER BY month;

WITH plan_transitions AS (
    SELECT 
        customer_id,
        plan_name,
        LAG(plan_name) OVER (PARTITION BY customer_id ORDER BY start_date) AS previous_plan
    FROM subscriptions
)
SELECT 
    previous_plan,
    plan_name,
    COUNT(*) AS transition_count
FROM plan_transitions
WHERE previous_plan IS NOT NULL
GROUP BY previous_plan, plan_name
ORDER BY transition_count DESC;

4-If the Foodie-Fi team were to create an exit survey shown to customers who wish to cancel their subscription, what questions would you include in the survey?
-- Analyze the reasons for cancellation and satisfaction ratings
SELECT 
    cancellation_reason,
    COUNT(*) AS number_of_cancellations,
    ROUND(AVG(satisfaction_rating), 2) AS avg_satisfaction_rating
FROM exit_surveys
GROUP BY cancellation_reason
ORDER BY number_of_cancellations DESC;

-- Fetch comments provided by customers who canceled
SELECT 
    customer_id,
    cancellation_reason,
    satisfaction_rating,
    comments
FROM exit_surveys
WHERE comments IS NOT NULL
ORDER BY satisfaction_rating ASC;

5-What business levers could the Foodie-Fi team use to reduce the customer churn rate? How would you validate the effectiveness of your ideas?
WITH churn_data AS (
    SELECT 
        customer_id,
        plan_name,
        CASE 
            WHEN start_date < '2020-06-01' THEN 'Before'
            ELSE 'After'
        END AS period,
        EXTRACT(MONTH FROM start_date) AS month
    FROM subscriptions
    WHERE plan_name = 'Cancelled'
)
SELECT 
    period,
    COUNT(DISTINCT customer_id) AS churn_count
FROM churn_data
GROUP BY period;
